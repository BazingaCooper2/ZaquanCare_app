# ðŸ“Š Shift Offers History - Widget Reference

## Overview

A comprehensive widget that displays shift offer history from the Supabase `shift_offers` table, showing both current pending offers and historical offers (accepted/rejected).

---

## ðŸ“± Features

### Main Features
âœ… **Tabbed Interface** - All / Pending / Accepted / Rejected  
âœ… **Statistics Dashboard** - Total offers, pending count, acceptance rate  
âœ… **Real-time Status** - Visual badges for each offer status  
âœ… **Detailed Views** - Tap any offer for full details  
âœ… **Pull to Refresh** - Swipe down to reload data  
âœ… **Animated Lists** - Smooth staggered animations  

### Data Displayed
- Offer ID and order
- Shift ID and Client ID
- Status (Pending/Accepted/Rejected/Expired)
- Sent timestamp
- Response time
- Response duration

---

## ðŸ—„ï¸ Database Schema

```sql
create table public.shift_offers (
  offers_id bigint generated by default as identity not null,
  emp_id bigint null,
  client_id bigint null,
  shift_id bigint null,
  status text null,  -- 'pending', 'accepted', 'rejected', 'expired'
  sent_at timestamp with time zone null,
  response_time timestamp with time zone null,
  offer_order bigint null,
  constraint shift_offers_pkey primary key (offers_id)
);
```

---

## ðŸ“ Files Created

### 1. Model
**`lib/models/shift_offer_record.dart`**
- Data model for shift_offers table
- JSON parsing from Supabase
- Helper methods for formatting dates, times
- Status color and display helpers

### 2. Service
**`lib/services/shift_offers_service.dart`**
- `fetchAllOffers(empId)` - Get all offers
- `fetchPendingOffers(empId)` - Get pending only
- `fetchAcceptedOffers(empId)` - Get accepted only
- `fetchRejectedOffers(empId)` - Get rejected only
- `updateOfferStatus(...)` - Update offer status
- `getOfferCounts(empId)` - Get statistics
- `getAcceptanceRate(empId)` - Calculate acceptance %

### 3. Page
**`lib/pages/shift_offers_page.dart`**
- Main UI widget with tabs
- Statistics card at top
- Four tab views (All/Pending/Accepted/Rejected)
- Offer detail dialog

### 4. Integration
**Modified: `lib/pages/dashboard_page.dart`**
- Added "Shift Offers" card
- Navigation to offers page

---

## ðŸŽ¨ UI Components

### Statistics Card
Shows:
- Total offers count
- Pending offers count
- Acceptance rate percentage

### Offer Card
Displays:
- Offer ID badge
- Offer order (if available)
- Status badge with color coding
- Time since sent
- Shift ID (if available)
- Client ID (if available)
- Response duration (for responded offers)

### Status Colors

| Status | Color | Icon |
|--------|-------|------|
| **Accepted** | Green | âœ“ check_circle |
| **Rejected** | Red | âœ— cancel |
| **Pending** | Orange | â³ pending |
| **Expired** | Grey | â° access_time |

---

## ðŸ”§ Usage

### Navigate to Offers Page

```dart
Navigator.of(context).push(
  MaterialPageRoute(
    builder: (context) => ShiftOffersPage(employee: employee),
  ),
);
```

### Fetch Offers Programmatically

```dart
import 'package:nurse_tracking_app/services/shift_offers_service.dart';

// Get all offers
final offers = await ShiftOffersService.fetchAllOffers(empId);

// Get pending only
final pending = await ShiftOffersService.fetchPendingOffers(empId);

// Get statistics
final counts = await ShiftOffersService.getOfferCounts(empId);
print('Total: ${counts['total']}');
print('Pending: ${counts['pending']}');

// Get acceptance rate
final rate = await ShiftOffersService.getAcceptanceRate(empId);
print('Acceptance Rate: ${rate.toStringAsFixed(1)}%');
```

### Update Offer Status

```dart
final success = await ShiftOffersService.updateOfferStatus(
  offersId: 123,
  status: 'accepted',
);
```

---

## ðŸ“Š Data Flow

```
1. User taps "Shift Offers" on Dashboard
   â†“
2. ShiftOffersPage loads
   â†“
3. Fetches data from Supabase:
   - All offers
   - Pending offers
   - Accepted offers
   - Rejected offers
   - Statistics
   â†“
4. Displays in tabbed interface
   â†“
5. User can:
   - Switch between tabs
   - Pull to refresh
   - Tap offer for details
```

---

## ðŸŽ¯ Example Data

### Sample Row in Database

```json
{
  "offers_id": 123,
  "emp_id": 456,
  "client_id": 789,
  "shift_id": 101,
  "status": "accepted",
  "sent_at": "2026-01-13T10:30:00Z",
  "response_time": "2026-01-13T10:32:15Z",
  "offer_order": 1
}
```

### Displayed As

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Offer #123          Order: 1         â•‘
â•‘                      [ACCEPTED âœ“]     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Sent: 2h ago                         â•‘
â•‘  Shift: #101                          â•‘
â•‘  Client: #789                         â•‘
â•‘                                       â•‘
â•‘  â±ï¸ Responded in 2m 15s               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ðŸ”„ Integration with Real-Time System

This history page works perfectly with the real-time shift offer system:

1. **Real-time offer received** â†’ WebSocket delivers offer
2. **Employee responds** â†’ Updates `shift_offers` table
3. **History updated** â†’ Pull to refresh to see latest

### Recommended Flow

```dart
// In shift_offer_dialog.dart, after accepting/rejecting:
await ShiftOffersService.updateOfferStatus(
  offersId: offer.shiftId,
  status: response == ShiftOfferResponse.accepted ? 'accepted' : 'rejected',
);
```

---

## ðŸ“ˆ Statistics Calculations

### Total Offers
Count of all records for employee

### Acceptance Rate
```dart
acceptanceRate = (acceptedCount / (acceptedCount + rejectedCount)) * 100
```

Excludes pending and expired from denominator.

---

## ðŸŽ¨ Customization

### Change Status Colors

Edit `_buildOfferCard()` in `shift_offers_page.dart`:

```dart
case 'accepted':
  statusColor = Colors.green;  // Change color here
  statusBgColor = Colors.green.shade50;
  statusIcon = Icons.check_circle;  // Change icon here
  break;
```

### Add New Tab

1. Increase tab count:
```dart
_tabController = TabController(length: 5, vsync: this); // was 4
```

2. Add tab:
```dart
Tab(
  text: 'Expired (${_counts['expired']})',
  icon: const Icon(Icons.timer_off),
),
```

3. Add tab view:
```dart
_buildOffersList(_expiredOffers, 'No expired offers'),
```

---

## ðŸ› Troubleshooting

### No offers showing
- Check if `emp_id` matches logged-in employee
- Verify Supabase connection
- Check console for errors
- Verify table has data

### Statistics not calculating
- Check if status values match exactly: 'pending', 'accepted', 'rejected'
- Verify timestamps are valid

### Pull to refresh not working
- Already implemented, should work automatically
- Check for console errors

---

## ðŸš€ Future Enhancements

### Possible Additions

1. **Filter by Date Range**
   ```dart
   .gte('sent_at', startDate)
   .lte('sent_at', endDate)
   ```

2. **Search by Shift/Client ID**
   ```dart
   .eq('shift_id', searchId)
   ```

3. **Export to CSV**
   - Add export button
   - Generate CSV from offers list

4. **Charts & Graphs**
   - Acceptance rate over time
   - Offers per day/week
   - Response time trends

5. **Notifications Badge**
   - Show pending count on dashboard card
   - Update badge in real-time

---

## ðŸ“ž Quick Reference

### Key Methods

```dart
// Get all offers
await ShiftOffersService.fetchAllOffers(empId);

// Get by status
await ShiftOffersService.fetchPendingOffers(empId);
await ShiftOffersService.fetchAcceptedOffers(empId);
await ShiftOffersService.fetchRejectedOffers(empId);

// Statistics
await ShiftOffersService.getOfferCounts(empId);
await ShiftOffersService.getAcceptanceRate(empId);

// Update
await ShiftOffersService.updateOfferStatus(
  offersId: id,
  status: 'accepted',
);
```

### Navigation

```dart
// From anywhere with BuildContext:
Navigator.of(context).push(
  MaterialPageRoute(
    builder: (context) => ShiftOffersPage(employee: employee),
  ),
);
```

---

**Created:** January 2026  
**Version:** 1.0.0  
**Status:** âœ… Ready to Use
